name: 🏗️ Build and Release custom RPI image and NixOS ISO

on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch: null
  schedule:
    - cron: 0 4 * * *
  push:
    paths:
      - "flake.lock"
      - "machines/nami/**"
      - "machines/nixiso/**"
      - ".github/workflows/daily-build.yaml"
  pull_request:
    paths:
      - "flake.lock"
      - "machines/nami/**"
      - "machines/nixiso/**"
      - ".github/workflows/daily-build.yaml"

# Workflow permissions
permissions:
  contents: write
  id-token: write

jobs:
  Build:
    name: Buildig 👷‍♂️ New 🆕 Nix ISO 📀
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Get current date
        id: date
        run: echo "date=$(TZ="Asia/Kolkata" date +'%d-%m-%Y')" >> "$GITHUB_OUTPUT"

      - name: Enable Github Cache for Nix store
        id: nix-cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Enable Cachix binary cache
        uses: cachix/cachix-action@v15
        with:
          name: vijay
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"

      - name: Update flake.lock
        run: nix flake update --accept-flake-config

      - name: Build NixOS ISO
        run: nix build --accept-flake-config .#nixos-iso

      - name: Rename NixOS ISO
        run: sudo mv ./result/iso/NixOS.iso "NixOS.iso"

      - name: Setup QEMU for ARM builds
        run: sudo apt-get update && sudo apt-get install -y qemu qemu-user-static binfmt-support

      - name: Build NixOS Image (ARM)
        run: nix build --accept-flake-config .#nixosConfigurations.nami.config.system.build.sdImage --system "aarch64-linux"

      - name: Rename NixOS Image (ARM)
        run: sudo mv ./result/sd-image/NixPi.img.zst "NixPi.img.zst"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Nixos Daily Build ${{ steps.date.outputs.date }}
          tag_name: "${{ steps.date.outputs.date }}"
          make_latest: true
          generate_release_notes: true
          files: |
            NixOS.iso
            NixPi.img.zst

      - name: Commit and Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Bot 🤖(flake): bump flake.lock"
          commit_user_name: Flake Bot
          commit_options: --no-verify --signoff
          commit_author: Flake Bot <github-actions@github.com>
          branch: master
          file_pattern: flake.lock
          skip_dirty_check: false
          skip_fetch: true
