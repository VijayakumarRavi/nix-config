# yamllint disable rule:line-length
name: ðŸ—ï¸ Nix Build & Cache
on:
  workflow_dispatch:
  schedule:
    - cron: 33 18 * * 1

permissions:
  contents: write
  id-token: write

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      linux_matrix: ${{ steps.set-matrix.outputs.linux }}
      macos_matrix: ${{ steps.set-matrix.outputs.macos }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Nix
        uses: DeterminateSystems/nix-installer-action@v20
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          extra-conf: |
            fallback = true
            sandbox = false
            http-connections = 128
            max-substitution-jobs = 128
            accept-flake-config = true
            extra-platforms = aarch64-linux
            substituters = https://nix-community.cachix.org?priority=41 https://numtide.cachix.org?priority=42 https://cache.nixos.org/
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs= numtide.cachix.org-1:2ps1kLBUWjxIneOy1Ik6cQjb41X0iXVXeHigGmycPPE=

      - name: Update flake.lock
        run: nix flake update

      - name: Upload flake.lock
        uses: actions/upload-artifact@v4
        with:
          name: flake-lock
          path: flake.lock
          overwrite: true

      - name: Generate Job Matrix
        id: set-matrix
        run: |
          MATRIX_JSON=$(nix eval --json --impure --expr '
          let
            flake = builtins.getFlake (toString ./.);
            mkList = attrs: builtins.map (name: {
              host = name;
              platform = attrs.${name}.config.nixpkgs.system;
            }) (builtins.attrNames attrs);
          in
          {
            linux = mkList (flake.nixosConfigurations or {});
            macos = mkList (flake.darwinConfigurations or {});
          }
          ')
          echo "linux=$(echo $MATRIX_JSON | jq -c '.linux')" >> "$GITHUB_OUTPUT"
          echo "macos=$(echo $MATRIX_JSON | jq -c '.macos')" >> "$GITHUB_OUTPUT"

  macos-build:
    needs: setup
    if: ${{ fromJson(needs.setup.outputs.macos_matrix)[0] != null }}
    runs-on: macos-latest
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.setup.outputs.macos_matrix) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Nix
        uses: DeterminateSystems/nix-installer-action@v20
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          extra-conf: |
            fallback = true
            sandbox = false
            http-connections = 128
            max-substitution-jobs = 128
            accept-flake-config = true
            extra-platforms = aarch64-linux
            substituters = https://nix-community.cachix.org?priority=41 https://numtide.cachix.org?priority=42 https://cache.nixos.org/
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs= numtide.cachix.org-1:2ps1kLBUWjxIneOy1Ik6cQjb41X0iXVXeHigGmycPPE=

      - name: Enable Cachix binary cache
        uses: cachix/cachix-action@v16
        with:
          name: vijay
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: Download flake.lock
        uses: actions/download-artifact@v5
        with:
          name: flake-lock
          path: .
          merge-multiple: true

      - name: Build System
        run: nix build .#darwinConfigurations.${{ matrix.host }}.config.system.build.toplevel

      - name: Build DevShell
        run: nix develop .# --profile dev-profile --command true

  linux-build:
    needs: setup
    if: ${{ fromJson(needs.setup.outputs.linux_matrix)[0] != null }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.setup.outputs.linux_matrix) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup QEMU for ARM builds
        if: matrix.machine.platform == 'aarch64-linux'
        uses: docker/setup-qemu-action@v3

      - name: Setup Nix
        uses: DeterminateSystems/nix-installer-action@v20
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          extra-conf: |
            fallback = true
            sandbox = false
            http-connections = 128
            max-substitution-jobs = 128
            accept-flake-config = true
            extra-platforms = aarch64-linux
            substituters = https://nix-community.cachix.org?priority=41 https://numtide.cachix.org?priority=42 https://cache.nixos.org/
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs= numtide.cachix.org-1:2ps1kLBUWjxIneOy1Ik6cQjb41X0iXVXeHigGmycPPE=

      - name: Enable Cachix binary cache
        uses: cachix/cachix-action@v16
        with:
          name: vijay
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: Download flake.lock
        uses: actions/download-artifact@v5
        with:
          name: flake-lock
          path: .
          merge-multiple: true

      - name: Build System
        run: nix build .#nixosConfigurations.${{ matrix.host }}.config.system.build.toplevel --system ${{ matrix.platform }}

      - name: Build DevShell
        run: nix develop .# --profile dev-profile --command true --system ${{ matrix.platform }}

  commit-lock:
    needs: [macos-build, linux-build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          ref: ${{ github.head_ref }}

      - uses: actions/download-artifact@v5
        with:
          name: flake-lock
          path: .
          merge-multiple: true

      - name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.PASSPHRASE }}
          git_user_signingkey: true
          git_commit_gpgsign: true

      - name: Push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'chore: update flake.lock'
          commit_options: -S --no-verify --signoff
          branch: master
          file_pattern: flake.lock
